name: GrabFreeProxy Hourly Update

on:
  workflow_dispatch:
  schedule:
    - cron: "*/20 * * * *"

jobs:
  update-proxies:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
      # ----------------------------------------
      # Checkout with robust retry protection
      # ----------------------------------------
      - name: Checkout Repository (more stable)
        uses: actions/checkout@v4
        with:
           fetch-depth: 1
           persist-credentials: false
           clean: true
           retries: 5

      # ----------------------------------------
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Dependencies
        run: |
          pip install requests beautifulsoup4 aiohttp lxml

      - name: Run GrabFreeProxy Script
        run: |
          chmod +x gfp.py
          python3 gfp.py

      # ----------------------------------------
      # Gist Update
      # ----------------------------------------
      - name: Update Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
        run: |
          pip install requests
          python3 - << 'EOF'
          import requests, json, os

          gist_id = os.getenv("GIST_ID")
          token = os.getenv("GIST_TOKEN")

          with open('gfp_proxy.json') as f:
             content = json.load(f)

          requests.patch(
             f'https://api.github.com/gists/{gist_id}',
             headers={'Authorization': f'token {token}'},
             json={'files': {'proxy.json': {'content': json.dumps(content, indent=2)}}}
          )
          EOF
